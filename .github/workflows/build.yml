name: Build and Generate

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build-java:
    name: Build Java
    runs-on: ubuntu-latest
    container:
      image: eclipse-temurin:17-jdk
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ant
        run: |
          apt-get update
          apt-get install -y ant

      - name: Show versions
        run: |
          java -version
          ant -version

      - name: Build all (Java generation)
        run: ant all

      - name: Upload generated Java source
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-java-source
          path: src-generated/java/
          retention-days: 30

      - name: Upload jars
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: opendis7-jars
          path: dist/*.jar
          retention-days: 30

  build-python:
    name: Build Python
    runs-on: ubuntu-latest
    container:
      image: eclipse-temurin:17-jdk

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ant and Python
        run: |
          apt-get update
          apt-get install -y ant python3

      - name: Show versions
        run: |
          java -version
          ant -version
          python3 --version

      - name: Compile generators
        run: |
          mkdir -p build/classes
          cp -r stringTemplates/* build/classes/
          find src-autogenerate src-supporting/java -name "*.java" > /tmp/sources.txt
          javac -d build/classes --release 17 @/tmp/sources.txt

      - name: Generate Python source
        run: ant generate-source-code-python

      - name: Verify Python syntax
        run: |
          echo "Checking all generated .py files compile..."
          find src-generated/python -name "*.py" > /tmp/pyfiles.txt
          total=$(wc -l < /tmp/pyfiles.txt)
          echo "Found $total .py files to check"
          failed=$(python3 -c "
          import py_compile, sys
          fails = 0
          with open('/tmp/pyfiles.txt') as f:
              for line in f:
                  path = line.strip()
                  try:
                      py_compile.compile(path, doraise=True)
                  except py_compile.PyCompileError as e:
                      print(f'FAIL: {path}: {e}', file=sys.stderr)
                      fails += 1
          print(fails)
          ")
          if [ "$failed" -ne 0 ]; then
            echo "FAIL: $failed files failed syntax check"
            exit 1
          fi
          echo "All $total files passed syntax check"

      - name: Verify no null() in output
        run: |
          if grep -r "null()" src-generated/python/; then
            echo "FAIL: found null() in generated Python output"
            exit 1
          fi
          echo "PASS: no null() found"

      - name: Verify package structure
        run: |
          echo "Checking package structure..."
          for dir in pdus enumerations entities objecttypes jammers io; do
            if [ ! -d "src-generated/python/opendis7/$dir" ]; then
              echo "FAIL: missing directory opendis7/$dir"
              exit 1
            fi
            if [ ! -f "src-generated/python/opendis7/$dir/__init__.py" ]; then
              echo "FAIL: missing __init__.py in opendis7/$dir"
              exit 1
            fi
            echo "  OK: opendis7/$dir/"
          done
          echo "PASS: all package directories present"

      - name: Report generation stats
        run: |
          echo "=== Generated Python Package Stats ==="
          for dir in pdus enumerations entities objecttypes jammers; do
            count=$(find "src-generated/python/opendis7/$dir" -name "*.py" ! -name "__init__.py" | wc -l)
            echo "  $dir: $count classes"
          done
          total=$(find src-generated/python -name "*.py" | wc -l)
          echo "  Total .py files: $total"

      - name: Upload generated Python source
        uses: actions/upload-artifact@v4
        with:
          name: generated-python-source
          path: src-generated/python/
          retention-days: 30
